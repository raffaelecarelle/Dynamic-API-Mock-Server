<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Mock Endpoints</h1>
        <div class="d-flex justify-content-between mb-3">
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMockModal">
                    <i class="bi bi-plus-circle"></i> Create Mock Endpoint
                </button>
                <select class="form-select d-inline-block w-auto ms-2" id="projectFilter">
                    <option value="">All Projects</option>
                </select>
            </div>
            <div class="input-group w-25">
                <input type="text" class="form-control" id="mockSearch" placeholder="Search endpoints...">
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Method</th>
                                <th>Path</th>
                                <th>Status</th>
                                <th>Dynamic</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mocksTable">
                            <!-- Mocks will be loaded here -->
                            <tr>
                                <td colspan="7" class="text-center">Loading mock endpoints...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Mock Modal -->
<div class="modal fade" id="createMockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Mock Endpoint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createMockForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mockProject" class="form-label">Project</label>
                            <select class="form-select" id="mockProject" required>
                                <option value="">Select a project</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="mockMethod" class="form-label">HTTP Method</label>
                            <select class="form-select" id="mockMethod" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="mockPath" class="form-label">Path</label>
                        <input type="text" class="form-control" id="mockPath" placeholder="/api/users/{id}" required>
                        <div class="form-text">Use {param} for path parameters</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mockStatusCode" class="form-label">Status Code</label>
                            <input type="number" class="form-control" id="mockStatusCode" value="200" required>
                        </div>
                        <div class="col-md-6">
                            <label for="mockDelay" class="form-label">Delay (ms)</label>
                            <input type="number" class="form-control" id="mockDelay" value="0" min="0" max="5000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="mockDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="mockDescription">
                    </div>
                    <div class="mb-3">
                        <label for="mockHeaders" class="form-label">Headers (JSON)</label>
                        <div id="headersJsonEditor" style="height: 100px;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="mockResponseBody" class="form-label">Response Body (JSON)</label>
                        <div id="responseBodyJsonEditor" style="height: 200px;"></div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="mockIsDynamic">
                        <label class="form-check-label" for="mockIsDynamic">Dynamic Response</label>
                    </div>
                    <div id="dynamicRulesSection" class="mb-3 d-none">
                        <label for="mockDynamicRules" class="form-label">Dynamic Rules (JSON)</label>
                        <div id="dynamicRulesJsonEditor" style="height: 200px;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMockBtn">Create Mock Endpoint</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Mock Modal -->
<div class="modal fade" id="editMockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Mock Endpoint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMockForm">
                    <input type="hidden" id="editMockId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editMockProject" class="form-label">Project</label>
                            <select class="form-select" id="editMockProject" required>
                                <option value="">Select a project</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editMockMethod" class="form-label">HTTP Method</label>
                            <select class="form-select" id="editMockMethod" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMockPath" class="form-label">Path</label>
                        <input type="text" class="form-control" id="editMockPath" placeholder="/api/users/{id}" required>
                        <div class="form-text">Use {param} for path parameters</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editMockStatusCode" class="form-label">Status Code</label>
                            <input type="number" class="form-control" id="editMockStatusCode" value="200" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editMockDelay" class="form-label">Delay (ms)</label>
                            <input type="number" class="form-control" id="editMockDelay" value="0" min="0" max="5000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMockDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="editMockDescription">
                    </div>
                    <div class="mb-3">
                        <label for="editMockHeaders" class="form-label">Headers (JSON)</label>
                        <div id="editHeadersJsonEditor" style="height: 100px;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editMockResponseBody" class="form-label">Response Body (JSON)</label>
                        <div id="editResponseBodyJsonEditor" style="height: 200px;"></div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editMockIsDynamic">
                        <label class="form-check-label" for="editMockIsDynamic">Dynamic Response</label>
                    </div>
                    <div id="editDynamicRulesSection" class="mb-3 d-none">
                        <label for="editMockDynamicRules" class="form-label">Dynamic Rules (JSON)</label>
                        <div id="editDynamicRulesJsonEditor" style="height: 200px;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateMockBtn">Update Mock Endpoint</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Mock Modal -->
<div class="modal fade" id="testMockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Mock Endpoint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Request URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="testMockUrl" readonly>
                        <button class="btn btn-outline-secondary copy-link-btn" type="button">Copy</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">cURL Command</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="testMockCurl" readonly>
                        <button class="btn btn-outline-secondary copy-link-btn" type="button">Copy</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Test Request</label>
                    <div class="d-flex mb-2">
                        <button type="button" class="btn btn-primary" id="sendTestRequestBtn">Send Request</button>
                    </div>
                </div>
                
                <div id="testResponseSection" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">Response Status</label>
                        <input type="text" class="form-control" id="testResponseStatus" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Response Headers</label>
                        <div id="testResponseHeadersEditor" style="height: 100px;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Response Body</label>
                        <div id="testResponseBodyEditor" style="height: 200px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Mock Confirmation Modal -->
<div class="modal fade" id="deleteMockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteMockId">
                <p>Are you sure you want to delete this mock endpoint?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Mock Endpoint</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.0/jsoneditor.min.js"></script>
<script>
    // Initialize JSON editors
    let headersEditor, responseBodyEditor, dynamicRulesEditor;
    let editHeadersEditor, editResponseBodyEditor, editDynamicRulesEditor;
    let testResponseHeadersEditor, testResponseBodyEditor;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize JSON editors for create form
        headersEditor = new JSONEditor(document.getElementById('headersJsonEditor'), {
            mode: 'code',
            mainMenuBar: false
        });
        headersEditor.set({"Content-Type": "application/json"});
        
        responseBodyEditor = new JSONEditor(document.getElementById('responseBodyJsonEditor'), {
            mode: 'code',
            mainMenuBar: false
        });
        responseBodyEditor.set({"message": "Success"});
        
        dynamicRulesEditor = new JSONEditor(document.getElementById('dynamicRulesJsonEditor'), {
            mode: 'code',
            mainMenuBar: false
        });
        dynamicRulesEditor.set([
            {
                "type": "random_number",
                "target": "data.id",
                "min": 1,
                "max": 1000
            }
        ]);
        
        // Initialize JSON editors for edit form
        editHeadersEditor = new JSONEditor(document.getElementById('editHeadersJsonEditor'), {
            mode: 'code',
            mainMenuBar: false
        });
        
        editResponseBodyEditor = new JSONEditor(document.getElementById('editResponseBodyJsonEditor'), {
            mode: 'code',
            mainMenuBar: false
        });
        
        editDynamicRulesEditor = new JSONEditor(document.getElementById('editDynamicRulesJsonEditor'), {
            mode: 'code',
            mainMenuBar: false
        });
        
        // Initialize JSON editors for test response
        testResponseHeadersEditor = new JSONEditor(document.getElementById('testResponseHeadersEditor'), {
            mode: 'view',
            mainMenuBar: false
        });
        
        testResponseBodyEditor = new JSONEditor(document.getElementById('testResponseBodyEditor'), {
            mode: 'view',
            mainMenuBar: false
        });
        
        // Toggle dynamic rules section
        document.getElementById('mockIsDynamic').addEventListener('change', function() {
            const dynamicRulesSection = document.getElementById('dynamicRulesSection');
            if (this.checked) {
                dynamicRulesSection.classList.remove('d-none');
            } else {
                dynamicRulesSection.classList.add('d-none');
            }
        });
        
        document.getElementById('editMockIsDynamic').addEventListener('change', function() {
            const dynamicRulesSection = document.getElementById('editDynamicRulesSection');
            if (this.checked) {
                dynamicRulesSection.classList.remove('d-none');
            } else {
                dynamicRulesSection.classList.add('d-none');
            }
        });
        
        // Load projects for dropdowns
        loadProjects();
        
        // Load mock endpoints
        loadMocks();
        
        // Setup event listeners
        setupEventListeners();
    });
    
    function loadProjects() {
        axios.get('/api/projects')
            .then(response => {
                if (response.data.status === 'success') {
                    const projects = response.data.data;
                    
                    // Populate project filter
                    const projectFilter = document.getElementById('projectFilter');
                    projectFilter.innerHTML = '<option value="">All Projects</option>';
                    
                    // Populate project dropdowns
                    const mockProject = document.getElementById('mockProject');
                    mockProject.innerHTML = '<option value="">Select a project</option>';
                    
                    const editMockProject = document.getElementById('editMockProject');
                    editMockProject.innerHTML = '<option value="">Select a project</option>';
                    
                    projects.forEach(project => {
                        // Add to filter
                        const filterOption = document.createElement('option');
                        filterOption.value = project.id;
                        filterOption.textContent = project.name;
                        projectFilter.appendChild(filterOption);
                        
                        // Add to create form
                        const createOption = document.createElement('option');
                        createOption.value = project.id;
                        createOption.textContent = project.name;
                        mockProject.appendChild(createOption);
                        
                        // Add to edit form
                        const editOption = document.createElement('option');
                        editOption.value = project.id;
                        editOption.textContent = project.name;
                        editMockProject.appendChild(editOption);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading projects:', error);
            });
    }
    
    function loadMocks(projectId = null) {
        const tableBody = document.getElementById('mocksTable');
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading mock endpoints...</td></tr>';
        
        let url = '/api/mocks';
        if (projectId) {
            url += `?project_id=${projectId}`;
        }
        
        axios.get(url)
            .then(response => {
                if (response.data.status === 'success') {
                    const mocks = response.data.data;
                    
                    if (mocks.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No mock endpoints found. Create your first mock endpoint!</td></tr>';
                        return;
                    }
                    
                    // Get project names
                    const projectIds = [...new Set(mocks.map(mock => mock.project_id))];
                    const projectPromises = projectIds.map(id => 
                        axios.get(`/api/projects/${id}`)
                            .then(response => ({
                                id,
                                name: response.data.data.name
                            }))
                            .catch(() => ({
                                id,
                                name: `Project ${id}`
                            }))
                    );
                    
                    Promise.all(projectPromises)
                        .then(projects => {
                            const projectMap = projects.reduce((map, project) => {
                                map[project.id] = project.name;
                                return map;
                            }, {});
                            
                            tableBody.innerHTML = '';
                            mocks.forEach(mock => {
                                const projectName = projectMap[mock.project_id] || `Project ${mock.project_id}`;
                                
                                tableBody.innerHTML += `
                                    <tr data-id="${mock.id}">
                                        <td>${projectName}</td>
                                        <td><span class="badge bg-${getMethodColor(mock.method)}">${mock.method}</span></td>
                                        <td>${mock.path}</td>
                                        <td><span class="badge bg-${getStatusColor(mock.status_code)}">${mock.status_code}</span></td>
                                        <td>${mock.is_dynamic ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                                        <td>${mock.description || '-'}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary test-mock-btn" data-mock-id="${mock.id}">
                                                    <i class="bi bi-play"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary edit-mock-btn" data-mock-id="${mock.id}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger delete-mock-btn" data-mock-id="${mock.id}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Setup row event listeners
                            setupRowEventListeners();
                        });
                }
            })
            .catch(error => {
                console.error('Error loading mocks:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading mock endpoints</td></tr>';
            });
    }
    
    function getMethodColor(method) {
        switch (method.toUpperCase()) {
            case 'GET': return 'primary';
            case 'POST': return 'success';
            case 'PUT': return 'warning';
            case 'DELETE': return 'danger';
            case 'PATCH': return 'info';
            default: return 'secondary';
        }
    }
    
    function getStatusColor(status) {
        if (status >= 200 && status < 300) return 'success';
        if (status >= 300 && status < 400) return 'info';
        if (status >= 400 && status < 500) return 'warning';
        if (status >= 500) return 'danger';
        return 'secondary';
    }
    
    function setupEventListeners() {
        // Project filter change
        document.getElementById('projectFilter').addEventListener('change', function() {
            const projectId = this.value;
            loadMocks(projectId || null);
        });
        
        // Create mock
        document.getElementById('saveMockBtn').addEventListener('click', function() {
            try {
                const mockData = {
                    project_id: document.getElementById('mockProject').value,
                    method: document.getElementById('mockMethod').value,
                    path: document.getElementById('mockPath').value,
                    status_code: parseInt(document.getElementById('mockStatusCode').value),
                    delay: parseInt(document.getElementById('mockDelay').value),
                    description: document.getElementById('mockDescription').value,
                    headers: headersEditor.get(),
                    response_body: responseBodyEditor.get(),
                    is_dynamic: document.getElementById('mockIsDynamic').checked
                };
                
                if (mockData.is_dynamic) {
                    mockData.dynamic_rules = dynamicRulesEditor.get();
                }
                
                axios.post('/api/mocks', mockData)
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Close modal and refresh mocks
                            const modal = bootstrap.Modal.getInstance(document.getElementById('createMockModal'));
                            modal.hide();
                            document.getElementById('createMockForm').reset();
                            loadMocks(document.getElementById('projectFilter').value || null);
                        }
                    })
                    .catch(error => {
                        console.error('Error creating mock endpoint:', error);
                        alert('Error creating mock endpoint: ' + (error.response?.data?.message || error.message));
                    });
            } catch (error) {
                alert('Invalid JSON format: ' + error.message);
            }
        });
        
        // Update mock
        document.getElementById('updateMockBtn').addEventListener('click', function() {
            try {
                const mockId = document.getElementById('editMockId').value;
                const mockData = {
                    project_id: document.getElementById('editMockProject').value,
                    method: document.getElementById('editMockMethod').value,
                    path: document.getElementById('editMockPath').value,
                    status_code: parseInt(document.getElementById('editMockStatusCode').value),
                    delay: parseInt(document.getElementById('editMockDelay').value),
                    description: document.getElementById('editMockDescription').value,
                    headers: editHeadersEditor.get(),
                    response_body: editResponseBodyEditor.get(),
                    is_dynamic: document.getElementById('editMockIsDynamic').checked
                };
                
                if (mockData.is_dynamic) {
                    mockData.dynamic_rules = editDynamicRulesEditor.get();
                }
                
                axios.put(`/api/mocks/${mockId}`, mockData)
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Close modal and refresh mocks
                            const modal = bootstrap.Modal.getInstance(document.getElementById('editMockModal'));
                            modal.hide();
                            loadMocks(document.getElementById('projectFilter').value || null);
                        }
                    })
                    .catch(error => {
                        console.error('Error updating mock endpoint:', error);
                        alert('Error updating mock endpoint: ' + (error.response?.data?.message || error.message));
                    });
            } catch (error) {
                alert('Invalid JSON format: ' + error.message);
            }
        });
        
        // Delete mock
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const mockId = document.getElementById('deleteMockId').value;
            
            axios.delete(`/api/mocks/${mockId}`)
                .then(response => {
                    if (response.data.status === 'success') {
                        // Close modal and refresh mocks
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteMockModal'));
                        modal.hide();
                        loadMocks(document.getElementById('projectFilter').value || null);
                    }
                })
                .catch(error => {
                    console.error('Error deleting mock endpoint:', error);
                    alert('Error deleting mock endpoint: ' + (error.response?.data?.message || error.message));
                });
        });
        
        // Send test request
        document.getElementById('sendTestRequestBtn').addEventListener('click', function() {
            const url = document.getElementById('testMockUrl').value;
            const method = document.getElementById('testMockUrl').dataset.method;
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
            
            axios({
                method: method,
                url: url
            })
                .then(response => {
                    // Show response
                    document.getElementById('testResponseStatus').value = `${response.status} ${response.statusText}`;
                    testResponseHeadersEditor.set(response.headers);
                    testResponseBodyEditor.set(response.data);
                    document.getElementById('testResponseSection').classList.remove('d-none');
                })
                .catch(error => {
                    if (error.response) {
                        // Show error response
                        document.getElementById('testResponseStatus').value = `${error.response.status} ${error.response.statusText}`;
                        testResponseHeadersEditor.set(error.response.headers);
                        testResponseBodyEditor.set(error.response.data);
                    } else {
                        // Show error message
                        document.getElementById('testResponseStatus').value = 'Error: ' + error.message;
                        testResponseHeadersEditor.set({});
                        testResponseBodyEditor.set({error: error.message});
                    }
                    document.getElementById('testResponseSection').classList.remove('d-none');
                })
                .finally(() => {
                    // Reset button
                    this.disabled = false;
                    this.innerHTML = 'Send Request';
                });
        });
        
        // Copy buttons
        document.querySelectorAll('.copy-link-btn').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                input.select();
                document.execCommand('copy');
                
                // Show copied message
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
        });
        
        // Search mocks
        document.getElementById('searchButton').addEventListener('click', searchMocks);
        document.getElementById('mockSearch').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchMocks();
            }
        });
    }
    
    function setupRowEventListeners() {
        // Test mock button
        document.querySelectorAll('.test-mock-btn').forEach(button => {
            button.addEventListener('click', function() {
                const mockId = this.dataset.mockId;
                
                axios.get(`/api/mocks/${mockId}`)
                    .then(response => {
                        if (response.data.status === 'success') {
                            const mock = response.data.data;
                            
                            // Get project info
                            axios.get(`/api/projects/${mock.project_id}`)
                                .then(projectResponse => {
                                    const project = projectResponse.data.data;
                                    
                                    // Set test URL and cURL command
                                    const baseUrl = window.location.origin;
                                    const mockUrl = `${baseUrl}/mock/${project.name}${mock.path}`;
                                    
                                    document.getElementById('testMockUrl').value = mockUrl;
                                    document.getElementById('testMockUrl').dataset.method = mock.method;
                                    
                                    const curlCommand = `curl -X ${mock.method} "${mockUrl}"`;
                                    document.getElementById('testMockCurl').value = curlCommand;
                                    
                                    // Reset test response section
                                    document.getElementById('testResponseSection').classList.add('d-none');
                                    
                                    // Show modal
                                    const modal = new bootstrap.Modal(document.getElementById('testMockModal'));
                                    modal.show();
                                })
                                .catch(error => {
                                    console.error('Error loading project details:', error);
                                    alert('Error loading project details: ' + (error.response?.data?.message || error.message));
                                });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading mock details:', error);
                        alert('Error loading mock details: ' + (error.response?.data?.message || error.message));
                    });
            });
        });
        
        // Edit mock button
        document.querySelectorAll('.edit-mock-btn').forEach(button => {
            button.addEventListener('click', function() {
                const mockId = this.dataset.mockId;
                
                axios.get(`/api/mocks/${mockId}`)
                    .then(response => {
                        if (response.data.status === 'success') {
                            const mock = response.data.data;
                            
                            document.getElementById('editMockId').value = mock.id;
                            document.getElementById('editMockProject').value = mock.project_id;
                            document.getElementById('editMockMethod').value = mock.method;
                            document.getElementById('editMockPath').value = mock.path;
                            document.getElementById('editMockStatusCode').value = mock.status_code;
                            document.getElementById('editMockDelay').value = mock.delay;
                            document.getElementById('editMockDescription').value = mock.description || '';
                            document.getElementById('editMockIsDynamic').checked = mock.is_dynamic;
                            
                            editHeadersEditor.set(mock.headers || {});
                            editResponseBodyEditor.set(mock.response_body || {});
                            
                            if (mock.is_dynamic) {
                                document.getElementById('editDynamicRulesSection').classList.remove('d-none');
                                editDynamicRulesEditor.set(mock.dynamic_rules || []);
                            } else {
                                document.getElementById('editDynamicRulesSection').classList.add('d-none');
                            }
                            
                            const modal = new bootstrap.Modal(document.getElementById('editMockModal'));
                            modal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading mock details:', error);
                        alert('Error loading mock details: ' + (error.response?.data?.message || error.message));
                    });
            });
        });
        
        // Delete mock button
        document.querySelectorAll('.delete-mock-btn').forEach(button => {
            button.addEventListener('click', function() {
                const mockId = this.dataset.mockId;
                
                document.getElementById('deleteMockId').value = mockId;
                
                const modal = new bootstrap.Modal(document.getElementById('deleteMockModal'));
                modal.show();
            });
        });
    }
    
    function searchMocks() {
        const searchTerm = document.getElementById('mockSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#mocksTable tr');
        
        rows.forEach(row => {
            const path = row.cells[2]?.textContent.toLowerCase() || '';
            const description = row.cells[5]?.textContent.toLowerCase() || '';
            
            if (path.includes(searchTerm) || description.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>