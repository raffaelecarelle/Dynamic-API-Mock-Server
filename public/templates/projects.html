<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Projects</h1>
        <div class="d-flex justify-content-between mb-3">
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProjectModal">
                    <i class="bi bi-plus-circle"></i> Create Project
                </button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importProjectModal">
                    <i class="bi bi-upload"></i> Import
                </button>
            </div>
            <div class="input-group w-25">
                <input type="text" class="form-control" id="projectSearch" placeholder="Search projects...">
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Endpoints</th>
                                <th>Public</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTable">
                            <!-- Projects will be loaded here -->
                            <tr>
                                <td colspan="6" class="text-center">Loading projects...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createProjectForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <div class="mb-3">
                        <label for="projectDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="projectDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="projectIsPublic">
                        <label class="form-check-label" for="projectIsPublic">Public Project</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProjectBtn">Create Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProjectForm">
                    <input type="hidden" id="editProjectId">
                    <div class="mb-3">
                        <label for="editProjectName" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="editProjectName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editProjectDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editProjectIsPublic">
                        <label class="form-check-label" for="editProjectIsPublic">Public Project</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateProjectBtn">Update Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Project Modal -->
<div class="modal fade" id="shareProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="shareProjectId">
                <div class="mb-3">
                    <label class="form-label">Project API Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="projectShareLink" readonly>
                        <button class="btn btn-outline-secondary copy-link-btn" type="button">Copy</button>
                    </div>
                    <div class="form-text">Use this link to access the project data via API</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mock Endpoints Base URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="mockShareLink" readonly>
                        <button class="btn btn-outline-secondary copy-link-btn" type="button">Copy</button>
                    </div>
                    <div class="form-text">Use this as the base URL for accessing mock endpoints</div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Anyone with these links can access your mock endpoints.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Project Modal -->
<div class="modal fade" id="exportProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="exportProjectId">
                <div class="mb-3">
                    <label class="form-label">Export Data (JSON)</label>
                    <div id="exportJsonEditor" style="height: 400px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadExportBtn">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Project Modal -->
<div class="modal fade" id="importProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">Import JSON File</label>
                    <input class="form-control" type="file" id="importFile" accept=".json">
                </div>
                <div class="mb-3">
                    <label class="form-label">Import Data (JSON)</label>
                    <div id="importJsonEditor" style="height: 400px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importProjectBtn">Import Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Project Confirmation Modal -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteProjectId">
                <p>Are you sure you want to delete this project? This will also delete all associated mock endpoints.</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Project</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.0/jsoneditor.min.js"></script>
<script>
    // Initialize JSON editors
    let exportEditor, importEditor;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize JSON editors
        const exportContainer = document.getElementById('exportJsonEditor');
        exportEditor = new JSONEditor(exportContainer, {
            mode: 'view',
            mainMenuBar: false
        });
        
        const importContainer = document.getElementById('importJsonEditor');
        importEditor = new JSONEditor(importContainer, {
            mode: 'code'
        });
        
        // Set default import template
        importEditor.set({
            project: {
                name: "My Imported Project",
                description: "Imported project description",
                is_public: false
            },
            mocks: []
        });
        
        // Load projects
        loadProjects();
        
        // Setup event listeners
        setupEventListeners();
    });
    
    function loadProjects() {
        const tableBody = document.getElementById('projectsTable');
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading projects...</td></tr>';
        
        axios.get('/api/projects')
            .then(response => {
                if (response.data.status === 'success') {
                    const projects = response.data.data;
                    
                    if (projects.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No projects found. Create your first project!</td></tr>';
                        return;
                    }
                    
                    tableBody.innerHTML = '';
                    projects.forEach(project => {
                        const createdAt = new Date(project.created_at).toLocaleDateString();
                        tableBody.innerHTML += `
                            <tr data-id="${project.id}">
                                <td>${project.name}</td>
                                <td>${project.description || '-'}</td>
                                <td><span class="badge bg-primary endpoint-count" data-project-id="${project.id}">...</span></td>
                                <td>${project.is_public ? '<span class="badge bg-success">Public</span>' : '<span class="badge bg-secondary">Private</span>'}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary view-mocks-btn" data-project-id="${project.id}">
                                            <i class="bi bi-code-slash"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary edit-project-btn" data-project-id="${project.id}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success share-project-btn" data-project-id="${project.id}" data-share-token="${project.share_token}">
                                            <i class="bi bi-share"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-info export-project-btn" data-project-id="${project.id}">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger delete-project-btn" data-project-id="${project.id}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Load endpoint counts
                    loadEndpointCounts();
                    
                    // Setup row event listeners
                    setupRowEventListeners();
                }
            })
            .catch(error => {
                console.error('Error loading projects:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading projects</td></tr>';
            });
    }
    
    function loadEndpointCounts() {
        const countBadges = document.querySelectorAll('.endpoint-count');
        
        countBadges.forEach(badge => {
            const projectId = badge.dataset.projectId;
            
            axios.get(`/api/mocks?project_id=${projectId}`)
                .then(response => {
                    if (response.data.status === 'success') {
                        badge.textContent = response.data.data.length;
                    }
                })
                .catch(error => {
                    console.error(`Error loading endpoint count for project ${projectId}:`, error);
                    badge.textContent = '?';
                });
        });
    }
    
    function setupEventListeners() {
        // Create project
        document.getElementById('saveProjectBtn').addEventListener('click', function() {
            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                is_public: document.getElementById('projectIsPublic').checked
            };
            
            axios.post('/api/projects', projectData)
                .then(response => {
                    if (response.data.status === 'success') {
                        // Close modal and refresh projects
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createProjectModal'));
                        modal.hide();
                        document.getElementById('createProjectForm').reset();
                        loadProjects();
                    }
                })
                .catch(error => {
                    console.error('Error creating project:', error);
                    alert('Error creating project: ' + (error.response?.data?.message || error.message));
                });
        });
        
        // Update project
        document.getElementById('updateProjectBtn').addEventListener('click', function() {
            const projectId = document.getElementById('editProjectId').value;
            const projectData = {
                name: document.getElementById('editProjectName').value,
                description: document.getElementById('editProjectDescription').value,
                is_public: document.getElementById('editProjectIsPublic').checked
            };
            
            axios.put(`/api/projects/${projectId}`, projectData)
                .then(response => {
                    if (response.data.status === 'success') {
                        // Close modal and refresh projects
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
                        modal.hide();
                        loadProjects();
                    }
                })
                .catch(error => {
                    console.error('Error updating project:', error);
                    alert('Error updating project: ' + (error.response?.data?.message || error.message));
                });
        });
        
        // Delete project
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const projectId = document.getElementById('deleteProjectId').value;
            
            axios.delete(`/api/projects/${projectId}`)
                .then(response => {
                    if (response.data.status === 'success') {
                        // Close modal and refresh projects
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteProjectModal'));
                        modal.hide();
                        loadProjects();
                    }
                })
                .catch(error => {
                    console.error('Error deleting project:', error);
                    alert('Error deleting project: ' + (error.response?.data?.message || error.message));
                });
        });
        
        // Import project
        document.getElementById('importFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        importEditor.set(data);
                    } catch (error) {
                        console.error('Error parsing JSON file:', error);
                        alert('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });
        
        document.getElementById('importProjectBtn').addEventListener('click', function() {
            try {
                const importData = importEditor.get();
                
                axios.post('/api/projects/import', importData)
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Close modal and refresh projects
                            const modal = bootstrap.Modal.getInstance(document.getElementById('importProjectModal'));
                            modal.hide();
                            loadProjects();
                        }
                    })
                    .catch(error => {
                        console.error('Error importing project:', error);
                        alert('Error importing project: ' + (error.response?.data?.message || error.message));
                    });
            } catch (error) {
                alert('Invalid JSON format: ' + error.message);
            }
        });
        
        // Download export
        document.getElementById('downloadExportBtn').addEventListener('click', function() {
            const exportData = exportEditor.get();
            const projectName = exportData.project?.name || 'project';
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `${projectName.toLowerCase().replace(/\s+/g, '-')}-export.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });
        
        // Copy share links
        document.querySelectorAll('.copy-link-btn').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                input.select();
                document.execCommand('copy');
                
                // Show copied message
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
        });
        
        // Search projects
        document.getElementById('searchButton').addEventListener('click', searchProjects);
        document.getElementById('projectSearch').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchProjects();
            }
        });
    }
    
    function setupRowEventListeners() {
        // View mocks button
        document.querySelectorAll('.view-mocks-btn').forEach(button => {
            button.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                window.location.href = `/dashboard/mocks?project_id=${projectId}`;
            });
        });
        
        // Edit project button
        document.querySelectorAll('.edit-project-btn').forEach(button => {
            button.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                
                axios.get(`/api/projects/${projectId}`)
                    .then(response => {
                        if (response.data.status === 'success') {
                            const project = response.data.data;
                            
                            document.getElementById('editProjectId').value = project.id;
                            document.getElementById('editProjectName').value = project.name;
                            document.getElementById('editProjectDescription').value = project.description || '';
                            document.getElementById('editProjectIsPublic').checked = project.is_public;
                            
                            const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
                            modal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading project details:', error);
                        alert('Error loading project details: ' + (error.response?.data?.message || error.message));
                    });
            });
        });
        
        // Share project button
        document.querySelectorAll('.share-project-btn').forEach(button => {
            button.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                const shareToken = this.dataset.shareToken;
                
                document.getElementById('shareProjectId').value = projectId;
                
                const baseUrl = window.location.origin;
                document.getElementById('projectShareLink').value = `${baseUrl}/api/share/${shareToken}`;
                document.getElementById('mockShareLink').value = `${baseUrl}/share/${shareToken}/`;
                
                const modal = new bootstrap.Modal(document.getElementById('shareProjectModal'));
                modal.show();
            });
        });
        
        // Export project button
        document.querySelectorAll('.export-project-btn').forEach(button => {
            button.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                
                document.getElementById('exportProjectId').value = projectId;
                
                axios.post(`/api/projects/${projectId}/export`)
                    .then(response => {
                        if (response.data.status === 'success') {
                            exportEditor.set(response.data.data);
                            
                            const modal = new bootstrap.Modal(document.getElementById('exportProjectModal'));
                            modal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error exporting project:', error);
                        alert('Error exporting project: ' + (error.response?.data?.message || error.message));
                    });
            });
        });
        
        // Delete project button
        document.querySelectorAll('.delete-project-btn').forEach(button => {
            button.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                
                document.getElementById('deleteProjectId').value = projectId;
                
                const modal = new bootstrap.Modal(document.getElementById('deleteProjectModal'));
                modal.show();
            });
        });
    }
    
    function searchProjects() {
        const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#projectsTable tr');
        
        rows.forEach(row => {
            const name = row.cells[0]?.textContent.toLowerCase() || '';
            const description = row.cells[1]?.textContent.toLowerCase() || '';
            
            if (name.includes(searchTerm) || description.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>